<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HLS Stream with MP4 Download</title>
    <style>
        body {
            background: #121212;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        video {
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .vjs-download-button .vjs-icon-placeholder::before {
            content: "⬇";
            font-size: 16px;
            cursor: pointer;
        }

        select#file_id {
            background-color: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 8px;
            margin-bottom: 1rem;
            min-width: 200px;
        }
    </style>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet"/>
    <style>
        /* Choices.js dark theme styling - must be after choices.min.css */
        .choices {
            margin-bottom: 1rem;
            min-width: 500px;
        }
        .choices__inner {
            background-color: #2a2a2a !important;
            border-color: #444 !important;
            color: white !important;
            min-height: 40px;
        }
        .choices__input {
            background-color: #2a2a2a !important;
            color: white !important;
        }
        .choices__input::placeholder {
            color: #888 !important;
        }
        .choices__list--dropdown {
            background-color: #2a2a2a !important;
            border-color: #444 !important;
        }
        .choices__list--dropdown .choices__item {
            color: white !important;
        }
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #444 !important;
        }
        .choices__list--single .choices__item {
            color: white !important;
        }
        .choices__placeholder {
            color: #888 !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>

<h2>Watch Online / Download for Offline Use</h2>
<label for="file_id">Αρχείο:</label>
<select id="file_id" onchange="updateFileSelection()"></select>
<br/>
<label for="video_id">Video Identity:</label>
<select id="video_id"></select>
<br/>
<table>
    <tr>
        <td>Συνολικά Video:</td>
        <td><label id="totalVideos"></label></td>
    </tr>
    <tr>
        <td>Αρ. Πρωτοκόλλου:</td>
        <td><label id="videoRelease"></label></td>
    </tr>
    <tr>
        <td>Identity:</td>
        <td><label id="videoIdentity"></label></td>
    </tr>
    <tr>
        <td>Code:</td>
        <td><label id="videoCode"></label></td>
    </tr>
    <tr>
        <td>Title:</td>
        <td><label id="videoName"></label></td>
    </tr>
</table>
<br/>

<video id="my-player" class="video-js" controls preload="auto" width="800" height="600" data-setup='{}'></video>
<script>
    const Button = videojs.getComponent('Button');
    const baseURL = 'https://sub-data.streaming.digitalschool.gov.gr';
    window.videoId = null;

    const urlParams = new URLSearchParams(window.location.search);
    const selected_video_id = urlParams.get('video_id');
    console.log(`selected_video_id: ${selected_video_id}`);

    // Store videos per file
    let filesData = {};
    let total_count = 0;
    let videoChoices = null;

    // List of JSON files to fetch
    const jsonFiles = [
        { file: '7390_28052025-20250608.json', name: '7390_28052025' },
        { file: '11189_28072025-20250729.json', name: '11189_28072025' },
        { file: '19075_27102025-20251028.json', name: '19075_27102025' },
        { file: '000001_23122025-20251223.json', name: '000001_23122025' },
        { file: '000001_10012026-20260119.json', name: '000001_10012026' }
    ];

    function handleVideoList(videosFile, name) {
        // Store videos for this file
        const videos = [];
        videosFile["existing_files"].forEach(vid => videos.push(vid));
        videosFile["missing_files"].forEach(vid => videos.push(vid));

        filesData[name] = videos;
        total_count += videos.length;
        document.getElementById('totalVideos').textContent = `${total_count}`;

        // Add option to file dropdown
        const fileSelect = document.getElementById('file_id');
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        fileSelect.appendChild(option);

        // Check if selected_video_id belongs to this file
        if (selected_video_id) {
            const found = videos.find(v => v.identity === selected_video_id);
            if (found) {
                fileSelect.value = name;
                updateFileSelection();
                if (videoChoices) {
                    videoChoices.setChoiceByValue(selected_video_id);
                }
                setVideo(selected_video_id);
            }
        } else if (fileSelect.options.length === 1) {
            // First file loaded, populate video dropdown
            updateFileSelection();
        }
    }

    function updateFileSelection() {
        const fileSelect = document.getElementById('file_id');
        const selectedFile = fileSelect.value;

        if (selectedFile && filesData[selectedFile]) {
            // Build choices array for Choices.js
            const choices = filesData[selectedFile].map(videoInfo => ({
                value: videoInfo.identity,
                label: videoInfo.identity
            }));

            // Update Choices.js
            if (videoChoices) {
                videoChoices.clearStore();
                videoChoices.setChoices(choices, 'value', 'label', true);
            }

            // Set first video
            if (choices.length > 0) {
                if (videoChoices) {
                    videoChoices.setChoiceByValue(choices[0].value);
                }
                setVideo(choices[0].value);
            }
        }
    }

    // Fetch all JSON files
    jsonFiles.forEach(({ file, name }) => {
        fetch(file)
            .then(response => response.json())
            .then(videos => handleVideoList(videos, name))
            .catch(err => console.error(`Error loading ${file}:`, err));
    });

    class DownloadButton extends Button {
        constructor(player, options) {
            super(player, options);
            this.controlText('Download Video');
        }

        handleClick() {
            const a = document.createElement('a');
            a.href = `${baseURL}/${window.videoId}/${window.videoId}.zip`;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }

    videojs.registerComponent('DownloadButton', DownloadButton);

    const player = videojs('my-player');

    // Initialize Choices.js on video dropdown
    videoChoices = new Choices('#video_id', {
        searchEnabled: true,
        searchPlaceholderValue: 'Search video...',
        itemSelectText: '',
        shouldSort: false,
        placeholder: true,
        placeholderValue: 'Select a video'
    });

    // Listen for change event from Choices.js
    document.getElementById('video_id').addEventListener('change', function(e) {
        updateVideo();
    });

    function updateVideo() {
        const selectElement = document.getElementById('video_id');
        console.log('Selected video: ' + selectElement.value);
        setVideo(selectElement.value);
    }

    function setVideo(theVideoId) {
        window.videoId = theVideoId;

        const selectedFile = document.getElementById('file_id').value;
        document.getElementById('videoRelease').textContent = selectedFile;

        if (selectedFile && filesData[selectedFile]) {
            const videoInfo = filesData[selectedFile].find(v => v.identity === theVideoId);
            if (videoInfo) {
                document.getElementById('videoIdentity').textContent = videoInfo.identity;
                document.getElementById('videoCode').textContent = videoInfo.code;
                document.getElementById('videoName').textContent = videoInfo.title;
            }
        }

        if (Hls.isSupported()) {
            console.log("hls supported");
            player.src({
                src: `${baseURL}/${theVideoId}/${theVideoId}.m3u8`,
                type: "application/vnd.apple.mpegurl"
            })
        } else {
            console.log("fallback to mp4");
            player.src({
                src: `${baseURL}/${theVideoId}/${theVideoId}.mp4`,
                type: "video/mp4"
            })
            // Dynamically add text tracks
            player.addRemoteTextTrack({
                kind: 'subtitles',
                src: `${baseURL}/${theVideoId}/subtitles_en.vtt`,
                srclang: 'en',
                label: 'English'
            }, false);

            player.addRemoteTextTrack({
                kind: 'subtitles',
                src: `${baseURL}/${theVideoId}/subtitles_el.vtt`,
                srclang: 'el',
                label: 'Greek'
            }, false);
        }
    }

    player.ready(() => {
        //download zip
        const downloadButton = player.controlBar.addChild('DownloadButton', {});
        downloadButton.addClass('vjs-download-button');
    });


</script>


</body>
</html>
